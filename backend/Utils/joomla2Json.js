// in order for this to work, edit dirlisting pl in the end like this
//
// if($ctf==1) {
// 	dprint("Checking Directory Listing");
// 	tprint("directory has directory listing : \n$cnftmp");
// } else{
// 	dprint("Checking Directory Listing");
// 	tprint("None");
// }

var fs = require('fs');

function convert2Json() {

    try {
        var array = fs.readFileSync('outputs/joomscanOutput').toString().split("\n");
        var json = new Object();
        var key = "Joomla Scan";
        json[key] = [];

        for (var i = 0; i < array.length; i++) {
            if (array[i].includes('FireWall Detector')) {
                key = "Firewall Detector";
                i++;
                json[key] = [];
                while (!array[i].includes('Detecting Joomla Version')) {
                    if (array[i] != '') {
                        if (array[i].startsWith('[++] ')) {
                            json[key].push(array[i].split('[++] ')[1]);
                        } else {
                            json[key].push(array[i]);
                        }
                    }
                    i++;
                }
                i--;
            } else if (array[i].includes('Detecting Joomla Version')) {
                key = "Joomla Version";
                i++;
                if (array[i].startsWith('[++] ')) {
                    json[key] = array[i].split('[++] ')[1];
                } else {
                    json[key] = array[i];
                }
                while (!array[i].includes('Core Joomla Vulnerability')) {
                    i++;
                }
                i--;
            } else if (array[i].includes('Core Joomla Vulnerability')) {
                key = "Vulnerabilities";
                i++;
                json[key] = [];
                while (!array[i].includes('Checking Directory Listing')) {
                    if (array[i] != '') {
                        var vulnerability = new Object();
                        var key = "name"
                        if (array[i].startsWith('[++] ')) {
                            vulnerability[key] = array[i].split('[++] ')[1];
                        } else {
                            vulnerability[key] = array[i];
                        }
                        i++;
                        if (array[i].includes('CVE')) {
                            var key = "CVE"
                            vulnerability[key] = array[i].split('CVE : ')[1];
                            i++;
                        }
                        if (array[i].includes('EDB')) {
                            var key = "EDB"
                            vulnerability[key] = array[i].split('EDB : ')[1];
                            i++;
                        }
                        json['Vulnerabilities'].push(vulnerability);
                    }
                    i++;
                }
                i--;
            } else if (array[i].includes('Checking Directory Listing')) {
                key = "Listing";
                i++;
                json[key] = [];
                while (!array[i].includes('Checking apache info/status files')) {
                    if (array[i] != '') {
                        var path = new Object();
                        var key = "path"
                        if (array[i].includes('http') || array[i].includes('https')) {
                            var key = "interestingPath"
                            path[key] = array[i];
                        }
                        json['Listing'].push(path);
                    }
                    i++;
                }
                i--;
            } else if (array[i].includes('Checking apache info/status files')) {
                key = "Apache";
                i++;
                json[key] = [];
                while (!array[i].includes('admin finder')) {
                    if (array[i] != '') {
                        if (array[i].startsWith('[++] ')) {
                            json[key].push(array[i].split('[++] ')[1]);
                        } else {
                            json[key].push(array[i]);
                        }
                    }
                    i++;
                }
                i--;
            } else if (array[i].includes('admin finder')) {
                key = "Admin";
                i++;
                json[key] = [];
                while (!array[i].includes('Checking robots.txt')) {
                    if (array[i] != '') {
                        if (array[i].includes('Admin page : ')) {
                            json[key] = array[i].split('[++] Admin page : ')[1];
                        }
                    }
                    i++;
                }
                i--;
            } else if (array[i].includes('Checking robots.txt')) {
                key = "Robots";
                i++;
                json[key] = [];
                while (!array[i].includes('Finding common backup files name')) {
                    if (array[i] != '') {
                        var path = new Object();
                        var key = "path"
                        if (array[i].includes('path : ')) {
                            var key = "path"
                            path[key] = array[i].split('path : ')[1];
                            json['Robots'].push(path);
                            i++;
                        } else if (array[i].includes('http') || array[i].includes('https')) {
                            var key = "interestingPath"
                            path[key] = array[i];
                            json['Robots'].push(path);
                        }
                    }
                    i++;
                }
                i--;
            } else if (array[i].includes('Finding common backup files name')) {
                key = "Backup";
                i++;
                json[key] = [];
                while (!array[i].includes('Finding common log files name')) {
                    if (array[i] != '') {
                        if (array[i].startsWith('[++] ')) {
                            json[key].push(array[i].split('[++] ')[1]);
                        } else {
                            json[key].push(array[i]);
                        }
                    }
                    i++;
                }
                i--;
            } else if (array[i].includes('Finding common log files name')) {
                key = "Logs";
                i++;
                json[key] = [];
                while (!array[i].includes('Checking sensitive config.php.x file')) {
                    if (array[i] != '') {
                        if (array[i].startsWith('[++] ')) {
                            json[key].push(array[i].split('[++] ')[1]);
                        } else {
                            json[key].push(array[i]);
                        }
                    }
                    i++;
                }
                i--;
            } else if (array[i].includes('Checking sensitive config.php.x file')) {
                key = "Config";
                i++;
                json[key] = [];
                while (!array[i].includes('Enumeration')) {
                    if (array[i] != '' && array[i].split(' : ')[1] != undefined) {
                        json[key].push(array[i].split(' : ')[1]);
                    }
                    i++;
                }
                i--;
            } else if (array[i].includes('Enumeration')) {
                key = "Components";
                json[key] = [];
                while (!array[i].includes('Your Report')) {
                    if (array[i] != '') {
                        console.log(array[i])
                        var components = new Object();
                        if (array[i].includes('Enumeration')) {
                            i++;
                        }
                        if (array[i].startsWith('[++] ')) {
                            var key = "name"
                            components[key] = array[i].split('[++] Name: ')[1];
                            i++;
                        }
                        if (array[i].includes('Location')) {
                            var key = "Location"
                            components[key] = array[i].split('Location : ')[1];
                            i++;
                        }
                        if (array[i].includes('Directory')) {
                            var key = "Directory Listing"
                            components[key] = array[i].split('Directory Listing : ')[1];
                            i++;
                        }
                        if (array[i].includes('Installed version')) {
                            var key = "installed_version"
                            components[key] = array[i].split('Installed version : ')[1];
                            i++;
                        }
                        if (array[i].includes('[!]')) {
                            i++;
                        }
                        if (array[i].includes('Title')) {
                            var key = "Title"
                            components[key] = array[i].split('Title : ')[1];
                            i++;
                        }
                        if (array[i].includes('Reference')) {
                            var key = "Reference"
                            components[key] = array[i].split('Reference : ')[1];
                            i++;
                        }
                        if (array[i].includes('readme.txt')) {
                            var key = "readme"
                            components[key] = array[i].split('readme.txt : ')[1];
                            i++;
                        }
                        if (array[i].includes('license.txt')) {
                            var key = "license"
                            components[key] = array[i].split('license.txt : ')[1];
                            i++;
                        }
                        if (array[i].includes('Fixed in')) {
                            var key = "fixed_in"
                            components[key] = array[i].split('Fixed in : ')[1];
                            i++;
                        }

                        json['Components'].push(components);
                    }
                    i++;
                }
                i--;
            }
        }
        return json;
    } catch (e) {
        return 'Error reading joomla to Json';
    }
}

const joomla2Json = () => {
    return new Promise((resolve, reject) => {
        const result = convert2Json();
        if (result === 'Error reading joomla to Json') {
            reject(result);
        } else {
            resolve(JSON.stringify(result));
        }
    })
}

// convert2Json();

module.exports = {
    joomla2Json: async() => {
        return await joomla2Json();
    }
};