const command = require('./command');
const nmap2Json = require('./nmap2Json');

const defaultNmapScan = (url) => {
    return new Promise((resolve, reject) => {
        command.execCommand('nmap -oX outputs/nmapOutput.xml ' + url, 'nmap')
            .then((commandOutput) => {
                // get open ports 
                const ports = commandOutput["host"]["ports"];
                const openPorts = [];
                ports.forEach(element => {
                    if (element["state"]["state"] === "open") {
                        openPorts.push(element["port"]["portid"]);
                    }
                });
                console.log('Nmap scan found these ports as open: ' + openPorts);
                resolve({ 'openPorts': openPorts })
            })
            .catch((err) => {
                reject(err);
            });
    });
};

function mapNmap2Json() {
    return new Promise((resolve, reject) => {
    nmap2Json.nmap2Json()
        .then((json) => {
            console.log('Finshed Convertion nmap.');
            resolve(json);
        })
        .catch((err) => {
            console.log(err);
            reject(err);
        });
    });
}

module.exports = {
    defaultNmapScan: async (url) => {
        return await defaultNmapScan(url);
    },
    mapNmap2Json: async () => {
        return await mapNmap2Json();
    }
};