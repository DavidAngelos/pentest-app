const {exec} = require('child_process');
const nmap2json = require('./processor');

const execCommand = (command) => {
  return new Promise((commandExecResolve, commandExecReject) => {
    exec(command, (err, stdout, stderr) => {
      if (err) {
        console.error("Exec error: ", err);
        commandExecReject("Command failed: " + command);
        return;
      }

      // the *entire* stdout and stderr (buffered)
      console.log(`stdout: ${stdout}`);
      console.log(`stderr: ${stderr}`);
      if (stderr) {
        commandExecReject(stderr);
        return;
      }
      if (stdout) { // the command finished successfully
        nmap2json.final()
          .then((json) => {
            console.log(json);
            commandExecResolve(json);
          })
          .catch((reject) => {
            console.log(reject);
          });
      }
    });
  })
};

module.exports = {
  execCommandExport: async (command) => {
    return await execCommand(command);
  }
};
