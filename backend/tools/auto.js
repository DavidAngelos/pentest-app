const nmap = require('./nmap');
const whatweb = require('./whatweb');
const wordpress = require('./wordpress');

const autoScan = (url) => {
    return new Promise((resolve, reject) => {
        nmap.nmapTool(url)
            .then((nmapOutput) => {
                const openPorts = nmapOutput['openPorts'];
                if (openPorts.includes('80')) {
                    // continue with whatweb scan
                    console.log(openPorts);
                    whatweb.whatwebTool(url)
                        .then((whatwebOutput) => {
                            if (Object.keys(whatwebOutput).includes('WordPress')) {
                                const wordpressVersion = whatwebOutput['WordPress']['version'];
                                console.log('Wordpress found with version ' + wordpressVersion);
                                // continue with wpscan scan
                                wordpress.wordpressTool_normal(url)
                                  .then((wordpressOutput) => {
                                    console.log(wordpressOutput);
                                    console.log('Interesting URLs found: ');
                                    wordpressOutput['interesting_findings'].forEach(finding => {
                                      console.log(finding['url']);
                                    });
              
                                    // bruteforce
                                    wordpress.wordpressTool_bruteforce(url)
                                      .then((wordpressOutput) => {
                                        console.log(wordpressOutput);
                                      });
              
                                  });
                              }
                        })
                }
            })
    });
};

function autoScanTool(url) {
    return new Promise((resolve, reject) => {
        console.log('here');
        autoScan(url)
            .then((commandOutput) => {
                // TODO: Do sth
                resolve(commandOutput);
            })
            .catch((err) => {
                reject(err);
            });
    });
}

module.exports = {
    autoScanTool: async (url) => {
        return await autoScanTool(url);
    }
};