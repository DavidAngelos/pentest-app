const nmap = require('./nmap');
const whatweb = require('./whatweb');
const wordpress = require('./wordpress');
const joomla = require('./joomla');
const whois = require('./whois');
const wapiti = require('./wapiti');

const customScan = (url, toolsSelected, proxy) => {
    return new Promise((resolve, reject) => {

        let count = 1;
        let output = {};

        if (toolsSelected.includes('nmap_default')) {
            nmap.nmapTool(url, "default")
                .then((nmapOutput) => {
                    output['nmap_default'] = nmapOutput;
                    count++;
                    if (count == toolsSelected.length) {
                        resolve(output);
                    }
                    console.log("Nmap default output: " + nmapOutput);
                })
                .catch(err => reject(err));
        }
        if (toolsSelected.includes('nmap_vuln')) {
            nmap.nmapTool(url, "common")
                .then((nmapOutput) => {
                    output['nmap_vuln'] = nmapOutput;
                    count++;
                    if (count == toolsSelected.length) {
                        resolve(output);
                    }
                    console.log("Nmap common vuln output: " + nmapOutput);
                })
                .catch(err => reject(err));
        }
        if (toolsSelected.includes('theharvester')) {
            whois.whoisTool(url, "default")
                .then((whoisInfo) => {
                    output['theharvester'] = whoisInfo;
                    count++;
                    if (count == toolsSelected.length) {
                        resolve(output);
                    }
                    console.log("Whois output: " + whoisInfo);
                })
                .catch((err) => reject(err));
        }
        if (toolsSelected.includes('whatweb')) {
            whatweb.whatwebTool(url, "default", proxy)
                .then((whatwebInfo) => {
                    output['whatweb'] = whatwebInfo;
                    count++;
                    if (count == toolsSelected.length) {
                        resolve(output);
                    }
                    console.log("Whatweb output: " + whatwebInfo);
                })
                .catch((err) => reject(err));
        }
        if (toolsSelected.includes('wapiti_sqli', proxy)) {
            wapiti.wapitiTool(url, "sqli")
                .then((wapitiInfo) => {
                    output['wapiti_sqli'] = wapitiInfo;
                    count++;
                    if (count == toolsSelected.length) {
                        resolve(output);
                    }
                    console.log("Wapiti sqli output: " + wapitiInfo);
                })
                .catch((err) => reject(err));
        }
        if (toolsSelected.includes('wapiti_xss', proxy)) {
            wapiti.wapitiTool(url, "xss")
                .then((wapitiInfo) => {
                    output['wapiti_xss'] = wapitiInfo;
                    count++;
                    if (count == toolsSelected.length) {
                        resolve(output);
                    }
                    console.log("Wapiti xss output: " + wapitiInfo);
                })
                .catch((err) => reject(err));
        }
        if (toolsSelected.includes('wpscan_default', proxy)) {
            wordpress.wordpressTool(url, "default")
                .then((wordpressOutput) => {
                    output['wpscan_default'] = wordpressOutput;
                    count++;
                    if (count == toolsSelected.length) {
                        resolve(output);
                    }
                    console.log("Wordpress default output: " + wordpressOutput);
                })
                .catch((err) => reject(err))
        }
        if (toolsSelected.includes('joomscan_default', proxy)) {
            joomla.joomlaTool(url, "default")
                .then((joomlaInfo) => {
                    output['joomscan_default'] = joomlaInfo;
                    count++;
                    if (count == toolsSelected.length) {
                        resolve(output);
                    }
                    console.log("Joomla default output: " + joomlaInfo);
                })
                .catch((err) => reject(err));
        }
        if (toolsSelected.includes('wpscan_bruteforce', proxy)) {
            wordpress.wordpressTool(url, "bruteforce")
                .then((wordpressOutput) => {
                    output['wpscan_bruteforce'] = wordpressOutput;
                    count++;
                    if (count == toolsSelected.length) {
                        resolve(output);
                    }
                    console.log("Wordpress default output: " + wordpressOutput);
                })
                .catch((err) => reject(err));
        }
        if (toolsSelected.includes('nmap_joomla')) {
            joomla.joomlaTool(url, "joomlaBrute")
                .then((nmapOutput) => {
                    output['nmap_joomla'] = nmapOutput;
                    count++;
                    if (count == toolsSelected.length) {
                        resolve(output);
                    }
                    console.log("Nmap joomla bruteforce output: " + nmapOutput);
                })
                .catch(err => reject(err));
        }
    });
};

function customScanTool(url, toolsSelected, proxy) {
    return new Promise((resolve, reject) => {
        customScan(url, toolsSelected, proxy)
            .then((commandOutput) => {
                // TODO: Do sth
                resolve(commandOutput);
            })
            .catch((err) => {
                reject(err);
            });
    });
}

module.exports = {
    customScanTool: async(url, toolsSelected, proxy) => {
        return await customScanTool(url, toolsSelected, proxy);
    }
};