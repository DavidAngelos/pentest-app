const command = require('../Utils/command');
const joomla2Json = require('../Utils/joomla2Json');
const config = require('../config/config');


const normalScan = (url) => {
    return new Promise((resolve, reject) => {
        console.log(config.JOOMSCAN + ' --url ' + url + ' -ec > outputs/joomscanOutput; echo "finished"');
        command.execCommand(config.JOOMSCAN + ' --url ' + url + ' -ec > /home/localhost/Downloads/pentest-app/outputs/joomscanOutput; echo "finished"', 'joomscan', '/home/localhost/Documents/tools/joomscan')
            .then((commandOutput) => {
                console.log(commandOutput)
                resolve(commandOutput);
            })
            .catch((err) => {
                reject(err);
            });
    });
};

function toJson() {
    return new Promise((resolve, reject) => {
        joomla2Json.joomla2Json()
            .then((json) => {
                console.log('Finished Convertion joomscan.');
                resolve(JSON.parse(json));
            })
            .catch((err) => {
                reject(err);
            });
    });
}

function joomlaTool(url, type) {
    return new Promise((resolve, reject) => {
        switch (type) {
            case "default":
                joomla_normal(url)
                    .then(commandOutput => resolve(commandOutput))
                    .catch(err => reject(err));
                break;
        }
    });
}

function joomla_normal(url) {
    return new Promise((resolve, reject) => {
        toJson()
            .then((json) => {
                resolve(json)
            })
            .catch((err) => {
                reject(err);
            });
        // COMMENTED FOR TESTING PURPOSES
        // normalScan(url)
        //     .then((commandOutput) => {
        //         if (commandOutput !== 'success') {
        //             reject(commandOutput);
        //         }
        //         toJson()
        //             .then((json) => {
        //                 resolve(json)
        //             })
        //             .catch((err) => {
        //                 reject(err);
        //             });
        //     })
        //     .catch((err) => {
        //         reject(err);
        //     });
    });
}


module.exports = {
    joomlaTool: async(url, type) => {
        return await joomlaTool(url, type);
    }
};