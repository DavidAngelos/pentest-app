const command = require('../Utils/command');
const fs = require('fs');
const config = require('../config/config');
const readline = require('readline');
const cleanURL = require('../Utils/cleanUrl');

const defaultScan = (hostname) => {
    return new Promise((resolve, reject) => {
        command.execCommand(config.SUBLIST3R + ' -d ' + hostname + ' -o outputs/sublist3r.txt', 'sublist3r')
            .then((commandOutput) => {
                resolve(commandOutput);
            })
            .catch((err) => {
                reject(err);
            });
    });
};

function toJson() {
    return new Promise((resolve, reject) => {
        const json = {};
        domains = []
        var lineReader = readline.createInterface({
            input: fs.createReadStream('outputs/sublist3r.txt')
        });

        lineReader.on('line', function(line) {
            domains.push(line);
        });
        lineReader.on('close', function() {
            json['URIs'] = domains;
            // command.execCommand('rm -f outputs/sublist3r.txt', 'clean');
            console.log('Finshed Convertion sublist3r.');
            resolve(json);
        });
    });
}

function sublist3rTool(url, type) {
    return new Promise((resolve, reject) => {
        switch (type) {
            case "default":
                sublist3rTool_default(cleanURL.extractHostname(url))
                    .then(commandOutput => resolve(commandOutput))
                    .catch(err => reject(err));
                break;
        }
    });
}

function sublist3rTool_default(domain) {
    return new Promise((resolve, reject) => {
        io.emit('progress', 'Enumerating subdomains..');
        // toJson()
        //     .then((json) => {
        //         resolve(json)
        //     })
        //     .catch((err) => {
        //         reject(err);
        //     });
        // COMMENTED FOR TESTING PURPOSES
        defaultScan(domain)
            .then((commandOutput) => {
                if (commandOutput !== 'success') {
                    reject(commandOutput);
                }
                toJson()
                    .then((json) => {
                        resolve(json)
                    })
                    .catch((err) => {
                        reject(err);
                    });
            })
            .catch((err) => {
                reject(err);
            });
    });
}



module.exports = {
    sublist3rTool: async(domain, type) => {
        return await sublist3rTool(domain, type);
    }
};