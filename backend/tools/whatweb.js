const command = require('../Utils/command');
const fs = require('fs');
const config = require('../config/config');


const defaultWhatWebScan = (url) => {
    return new Promise((resolve, reject) => {
        command.execCommand(config.WHATWEB + ' ' + url + ' --log-json=outputs/whatwebOutput', 'whatweb')
            .then((commandOutput) => {
                resolve(commandOutput);
            })
            .catch((err) => {
                reject(err);
            });
    });
};

function whatweb2Json() {
    return new Promise((resolve, reject) => {
        let rawData = fs.readFileSync('outputs/whatwebOutput');
        let json = JSON.parse(rawData);
        command.execCommand('rm -f outputs/whatwebOutput', 'clean');
        console.log('Finshed Convertion whatweb.');
        resolve(json);
    });
}

function whatwebInfo(json) {
    return new Promise((resolve, reject) => {
        let plugins = null;
        json.forEach(info => {
          if (info['plugins'] !== undefined) {
            if (info['plugins']['RedirectLocation'] === undefined) {
              plugins = info['plugins'];
            }
          }
        });
    });
}

module.exports = {
    defaultWhatWebScan: async (url) => {
        return await defaultWhatWebScan(url);
    },
    whatweb2Json: async () => {
        return await whatweb2Json();
    },
    whatwebInfo: async (json) => {
        return await whatwebInfo(json);
    }
};